#pragma config(Sensor, in1,    TubeSensor,          sensorLineFollower)
#pragma config(Motor,  port2,           testMotor,     tmotorNormal, openLoop)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

#pragma platform(VEX)

//Competition Control and Duration Settings
#pragma competitionControl(Competition)
#pragma autonomousDuration(20)
#pragma userControlDuration(120)

#include "Vex_Competition_Includes.c"   //Main competition background code...do not modify!

int lightMaxValue = 0;
int tubeCount = 0;
int spinOutPrev = 0;
int fullLightCycles = 0;
int justSpunOut = 0;

/////////////////////////////////////////////////////////////////////////////////////////
//
//                          Pre-Autonomous Functions
//
// You may want to perform some actions before the competition starts. Do them in the
// following function.
//
/////////////////////////////////////////////////////////////////////////////////////////

void pre_auton()
{
	// All activities that occur before the competition starts
	// Example: clearing encoders, setting servo positions, ...
}




/////////////////////////////////////////////////////////////////////////////////////////
//
//                                 Autonomous Task
//
// This task is used to control your robot during the autonomous phase of a VEX Competition.
// You must modify the code to add your own robot specific commands here.
//
/////////////////////////////////////////////////////////////////////////////////////////

task autonomous()
{
  // .....................................................................................
  // Insert user code here.
  // .....................................................................................

	AuonomousCodePlaceholderForTesting();  // Remove this function call once you have "real" code.
}

int tubeCounter() {
    int motorValue;
  	short sensor_val = SensorValue(TubeSensor);
    int spinOut = vexRT[Btn6U];
  	if ((spinOut != spinOutPrev) && spinOut){
	    tubeCount++;
	  }

	  spinOutPrev = spinOut;

	  if (tubeCount > 0) {
	    motorValue = 127;
      justSpunOut = 3;
	    if (sensor_val < (lightMaxValue - 800)) {
	      tubeCount--;
	      lightMaxValue = 0;
	    } else {
      if (lightMaxValue < sensor_val) {
         lightMaxValue = sensor_val;
       }
      }
    } else if (tubeCount == 0 && justSpunOut > 0) {
      justSpunOut--;
      motorValue = -127;
    } else {
      lightMaxValue = 0;
      motorValue = 0;
    }

    if (fullLightCycles > 3) {
      tubeCount = 0;
      fullLightCycles = 0;
    } else if (sensor_val > 3000) {
      fullLightCycles++;
    }




    return motorValue;
 }

 int spinners(){
   int motorValue;
  if (vexRT[Btn6D]){
    motorValue = -127;
    tubeCount = 0;
  } else if (vexRT(Btn8U)) {
    motorValue = 127;
    tubeCount = 0;
  } else {
    motorValue = tubeCounter();
  }
    return motorValue;
 }

/////////////////////////////////////////////////////////////////////////////////////////
//
//                                 User Control Task
//
// This task is used to control your robot during the user control phase of a VEX Competition.
// You must modify the code to add your own robot specific commands here.
//
/////////////////////////////////////////////////////////////////////////////////////////

task usercontrol()
{
	// User control code here, inside the loop

	while (true)
	{


	  motor[testMotor] = spinners();
	  // This is the main execution loop for the user control program. Each time through the loop
	  // your program should update motor + servo values based on feedback from the joysticks.

	  // .....................................................................................
	  // Insert user code here. This is where you use the joystick values to update your motors, etc.
	  // .....................................................................................

	  UserControlCodePlaceholderForTesting(); // Remove this function call once you have "real" code.
	}
}
